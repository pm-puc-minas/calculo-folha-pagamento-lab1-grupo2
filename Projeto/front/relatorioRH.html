<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios de Folha - RH</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f0f2f5; color: #333; }

        .navbar { background-color: #ffffff; height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        .navbar-brand { font-size: 1.5rem; font-weight: bold; color: #007bff; text-decoration: none; }
        .nav-links { display: flex; list-style: none; gap: 20px; }
        .nav-links a { text-decoration: none; color: #555; font-weight: 500; padding: 8px 12px; border-radius: 5px; transition: all 0.3s; }
        .nav-links a.active { color: #007bff; background-color: #e9ecef; }
        .nav-links a:hover { background-color: #e9ecef; color: #007bff; }
        .btn-logout { padding: 8px 20px; background-color: transparent; border: 1px solid #dc3545; color: #dc3545; border-radius: 5px; cursor: pointer; font-weight: bold; transition: all 0.3s; }
        .btn-logout:hover { background-color: #dc3545; color: white; }

        .main-container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        .header-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }

        .filter-card { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; display: flex; gap: 15px; flex-wrap: wrap; align-items: end; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-size: 0.9rem; font-weight: 500; color: #555; }
        .form-control { padding: 10px; border: 1px solid #ccc; border-radius: 5px; min-width: 150px; }
        .btn-filter { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }

        .results-card { background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px 20px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; color: #555; font-weight: 600; }
        tr:hover { background-color: #f1f3f5; }

        .btn-view { background-color: #17a2b8; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: opacity 0.3s; }
        .btn-view:hover { opacity: 0.8; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background-color: #fff; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; border-radius: 8px; box-shadow: 0 5px 25px rgba(0,0,0,0.2); animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .holerite-paper { padding: 40px; border: 1px solid #ddd; margin: 20px; font-family: 'Courier New', Courier, monospace; }
        .holerite-header { border-bottom: 2px solid #333; margin-bottom: 20px; padding-bottom: 10px; display: flex; justify-content: space-between; }
        .holerite-table { width: 100%; margin-bottom: 20px; border: 1px solid #333; }
        .holerite-table th, .holerite-table td { border: 1px solid #ccc; padding: 8px; font-size: 0.9rem; }
        .holerite-footer { background-color: #f8f9fa; border: 1px solid #333; padding: 15px; display: flex; justify-content: space-between; font-weight: bold; }
        .modal-actions { padding: 15px 20px; background-color: #f8f9fa; border-top: 1px solid #eee; text-align: right; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; }
        .btn-close { background-color: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }

        .alert { padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .alert-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .alert-danger { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .empty-state { text-align: center; padding: 40px; color: #666; }

        @media (max-width: 768px) {
            .navbar { flex-direction: column; height: auto; padding: 15px; }
            .nav-links { margin: 15px 0; gap: 10px; }
            .filter-card { flex-direction: column; align-items: stretch; }
            .holerite-paper { padding: 10px; font-size: 0.8rem; }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <a href="home.html" class="navbar-brand">Portal Colaborador</a>

        <ul class="nav-links">
            <li><a href="gerenciamentoFuncionarioRH.html">Gerenciamento de Funcionários</a></li>
            <li><a href="FolhaPagamento.html">Folha de Pagamento</a></li>
            <li><a href="relatorioRH.html" class="active">Relatórios</a></li>
        </ul>

        <button onclick="fazerLogout()" class="btn-logout">Logout</button>
    </nav>

    <main class="main-container">

        <div class="header-section">
            <h2>Relatório da Folha de Pagamento - RH</h2>
        </div>

        <div id="alertContainer"></div>

        <div class="filter-card">
            <div class="filter-group">
                <label>Competência:</label>
                <select id="filtroMes" class="form-control">
                    <option value="">Todos os meses</option>
                </select>
            </div>

            <div class="filter-group" style="flex: 1;">
                <label>Buscar Funcionário:</label>
                <input type="text" id="filtroBusca" class="form-control" placeholder="Nome ou Matrícula">
            </div>

            <button class="btn-filter" onclick="aplicarFiltros()">Aplicar Filtros</button>
            <button class="btn-filter" onclick="carregarDados()" style="background-color: #28a745;">Recarregar</button>
        </div>

        <div class="results-card">
            <table>
                <thead>
                    <tr>
                        <th>Matrícula</th>
                        <th>Funcionário</th>
                        <th>Cargo</th>
                        <th>Competência</th>
                        <th>Salário Bruto</th>
                        <th>Descontos</th>
                        <th>Líquido</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="tabelaCorpo">
                    <tr>
                        <td colspan="8" class="empty-state">Carregando...</td>
                    </tr>
                </tbody>
            </table>
        </div>

    </main>

    <div id="modalHolerite" class="modal-overlay">
        <div class="modal-content">
            <div class="holerite-paper">
                <div class="holerite-header">
                    <div>
                        <strong>EMPRESA TECH SOLUTIONS LTDA</strong><br>
                        CNPJ: 00.000.000/0001-99
                    </div>
                    <div style="text-align: right;">
                        <strong>Recibo de Pagamento</strong><br>
                        Ref: <span id="modalCompetencia">-</span>
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <strong>Funcionário:</strong> <span id="modalNome">-</span><br>
                    <strong>Matrícula:</strong> <span id="modalMatricula">-</span><br>
                    <strong>Cargo:</strong> <span id="modalCargo">-</span>
                </div>

                <table class="holerite-table">
                    <thead>
                        <tr style="background-color: #eee;">
                            <th>Descrição</th>
                            <th>Tipo</th>
                            <th style="text-align: right;">Vencimentos</th>
                            <th style="text-align: right;">Descontos</th>
                        </tr>
                    </thead>
                    <tbody id="modalItens">
                        <tr><td colspan="4" style="text-align: center;">Sem itens</td></tr>
                    </tbody>
                </table>

                <div class="holerite-footer">
                    <div><span>Total Vencimentos</span><br><span id="footerProventos" style="color: #28a745;">R$ 0,00</span></div>
                    <div><span>Total Descontos</span><br><span id="footerDescontos" style="color: #dc3545;">R$ 0,00</span></div>
                    <div style="background-color: #ddd; padding: 5px 10px; border-radius: 4px;">
                        <span>Líquido a Receber</span><br><strong id="modalLiquido" style="font-size: 1.2rem;">R$ 0,00</strong>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn-close" onclick="fecharHolerite()">Fechar</button>
                <button class="btn-filter" onclick="window.print()">Imprimir</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/Config.js"></script>
    <script src="js/AuthClient.js"></script>
    <script src="js/AuthService.js"></script>
    <script src="js/FuncionarioClient.js"></script>
    <script src="js/FolhaPagamentoClient.js"></script>
    <script src="js/Utils.js"></script>

    <script>
        let todasFolhas = [];
        let funcionariosMap = new Map();

        window.addEventListener('DOMContentLoaded', async () => {
            AuthService.inicializar();
            await carregarDados();
        });

        function fazerLogout() {
            if (confirm('Deseja realmente sair do sistema?')) {
                AuthService.logout();
                window.location.href = 'login.html';
            }
        }

        async function carregarDados() {
            try {
                showAlert('Carregando dados...', 'info');

                const [folhas, funcionarios] = await Promise.all([
                    FolhaPagamentoClient.buscarTodas(),
                    FuncionarioClient.buscarTodos()
                ]);

                todasFolhas = folhas;
                funcionariosMap.clear();
                funcionarios.forEach(f => funcionariosMap.set(f.idPessoa, f));

                preencherFiltroMes();
                exibirFolhas(todasFolhas);
                clearAlert();

            } catch (error) {
                showAlert('Erro ao carregar dados: ' + error.message, 'danger');
                document.getElementById('tabelaCorpo').innerHTML =
                    '<tr><td colspan="8" class="empty-state">Erro ao carregar dados</td></tr>';
            }
        }

        function preencherFiltroMes() {
            const select = document.getElementById('filtroMes');
            const mesesUnicos = new Set();

            todasFolhas.forEach(folha => {
                if (folha.mesReferencia) {
                    mesesUnicos.add(folha.mesReferencia);
                }
            });

            const mesesOrdenados = Array.from(mesesUnicos).sort((a, b) => b - a);

            select.innerHTML = '<option value="">Todos os meses</option>';
            mesesOrdenados.forEach(mes => {
                const option = document.createElement('option');
                option.value = mes;
                option.textContent = formatarCompetencia(mes);
                select.appendChild(option);
            });
        }

        function formatarCompetencia(mesReferencia) {
            const mesRef = String(mesReferencia);
            if (mesRef.length !== 6) return mesRef;

            const ano = mesRef.substring(0, 4);
            const mes = mesRef.substring(4, 6);
            const meses = ['', 'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                           'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

            return `${meses[parseInt(mes)]}/${ano}`;
        }

        function aplicarFiltros() {
            const filtroMes = document.getElementById('filtroMes').value;
            const filtroBusca = document.getElementById('filtroBusca').value.toLowerCase().trim();

            let folhasFiltradas = todasFolhas;

            if (filtroMes) {
                folhasFiltradas = folhasFiltradas.filter(f => f.mesReferencia == filtroMes);
            }

            if (filtroBusca) {
                folhasFiltradas = folhasFiltradas.filter(folha => {
                    const func = funcionariosMap.get(folha.matricula);
                    if (!func) return false;

                    const matchNome = func.nome.toLowerCase().includes(filtroBusca);
                    const matchMatricula = String(folha.matricula).includes(filtroBusca);
                    return matchNome || matchMatricula;
                });
            }

            exibirFolhas(folhasFiltradas);
        }

        function exibirFolhas(folhas) {
            const tbody = document.getElementById('tabelaCorpo');

            if (folhas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Nenhuma folha encontrada</td></tr>';
                return;
            }

            tbody.innerHTML = '';

            folhas.forEach(folha => {
                const func = funcionariosMap.get(folha.matricula);
                const tr = document.createElement('tr');

                const nomeFuncionario = func ? func.nome : 'Desconhecido';
                const cargo = func ? (func.cargo || 'N/A') : 'N/A';

                tr.innerHTML = `
                    <td>${folha.matricula}</td>
                    <td>${nomeFuncionario}</td>
                    <td>${cargo}</td>
                    <td>${formatarCompetencia(folha.mesReferencia)}</td>
                    <td>${formatarMoeda(folha.salarioBruto)}</td>
                    <td style="color: #dc3545;">${formatarMoeda(folha.totalDesconto)}</td>
                    <td style="color: #28a745; font-weight: bold;">${formatarMoeda(folha.salarioLiquido)}</td>
                    <td>
                        <button class="btn-view" onclick='abrirHolerite(${JSON.stringify(folha).replace(/'/g, "&#39;")})'>
                            Ver Contracheque
                        </button>
                    </td>
                `;

                tbody.appendChild(tr);
            });
        }

        function abrirHolerite(folha) {
            const func = funcionariosMap.get(folha.matricula);

            document.getElementById('modalNome').textContent = func ? func.nome : 'Desconhecido';
            document.getElementById('modalMatricula').textContent = folha.matricula;
            document.getElementById('modalCargo').textContent = func ? (func.cargo || 'N/A') : 'N/A';
            document.getElementById('modalCompetencia').textContent = formatarCompetencia(folha.mesReferencia);

            const tbody = document.getElementById('modalItens');
            tbody.innerHTML = '';

            if (!folha.itens || folha.itens.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Sem itens calculados</td></tr>';
            } else {
                folha.itens.forEach(item => {
                    const tr = document.createElement('tr');
                    const isProvento = item.tipo === 'PROVENTO';

                    tr.innerHTML = `
                        <td>${item.desc}</td>
                        <td>${item.tipo}</td>
                        <td style="text-align: right; color: #28a745;">${isProvento ? formatarMoeda(item.valor) : '-'}</td>
                        <td style="text-align: right; color: #dc3545;">${!isProvento ? formatarMoeda(item.valor) : '-'}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            document.getElementById('footerProventos').textContent = formatarMoeda(folha.totalProvento);
            document.getElementById('footerDescontos').textContent = formatarMoeda(folha.totalDesconto);
            document.getElementById('modalLiquido').textContent = formatarMoeda(folha.salarioLiquido);

            document.getElementById('modalHolerite').style.display = 'flex';
        }

        function fecharHolerite() {
            document.getElementById('modalHolerite').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('modalHolerite');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        function formatarMoeda(valor) {
            if (valor == null) return 'R$ 0,00';
            const num = typeof valor === 'number' ? valor : parseFloat(valor);
            return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        }

        function clearAlert() {
            document.getElementById('alertContainer').innerHTML = '';
        }
    </script>

</body>
</html>
